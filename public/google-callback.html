<!DOCTYPE html>
<html>
<head>
  <title>Google Connection</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      background: #1a1a2e;
      color: #fff;
    }
    .container { 
      text-align: center; 
      padding: 2rem;
    }
    .success-icon {
      width: 64px;
      height: 64px;
      background: #22c55e;
      border-radius: 50%;
      margin: 0 auto 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .success-icon svg {
      width: 32px;
      height: 32px;
      color: white;
    }
    .error-icon {
      width: 64px;
      height: 64px;
      background: #ef4444;
      border-radius: 50%;
      margin: 0 auto 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .error-icon svg {
      width: 32px;
      height: 32px;
      color: white;
    }
    h1 { 
      font-size: 1.5rem; 
      margin-bottom: 0.5rem;
    }
    p { 
      color: #a0a0a0; 
      margin: 0;
    }
    .email {
      color: #4285f4;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="container" id="content">
    <div class="success-icon" id="success-icon" style="display: none;">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
      </svg>
    </div>
    <div class="error-icon" id="error-icon" style="display: none;">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </div>
    <h1 id="title">Processing...</h1>
    <p id="message">Please wait</p>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const success = params.get('success') === 'true';
    const email = params.get('email');
    const feature = params.get('feature');
    const error = params.get('error');

    const successIcon = document.getElementById('success-icon');
    const errorIcon = document.getElementById('error-icon');
    const title = document.getElementById('title');
    const message = document.getElementById('message');

    if (success) {
      successIcon.style.display = 'flex';
      title.textContent = 'Connected!';
      message.innerHTML = email 
        ? 'Connected as <span class="email">' + email + '</span>'
        : 'Your Google account is now connected.';

      // Notify parent window
      if (window.opener) {
        window.opener.postMessage({
          type: 'google-oauth-success',
          email: email,
          feature: feature,
        }, '*');
      }

      // Close after delay
      setTimeout(() => window.close(), 2000);
    } else {
      errorIcon.style.display = 'flex';
      title.textContent = 'Connection Failed';
      
      const errorMessages = {
        'access_denied': 'You declined the permission request.',
        'missing_params': 'Missing required parameters.',
        'invalid_state': 'Invalid state parameter.',
        'state_not_found': 'Session expired. Please try again.',
        'state_mismatch': 'Session mismatch. Please try again.',
        'token_exchange_failed': 'Failed to complete authentication.',
        'storage_failed': 'Failed to save connection.',
        'config_error': 'Google OAuth is not configured.',
      };

      message.textContent = errorMessages[error] || error || 'An error occurred.';

      // Notify parent window
      if (window.opener) {
        window.opener.postMessage({
          type: 'google-oauth-error',
          error: error,
        }, '*');
      }

      // Close after delay
      setTimeout(() => window.close(), 3000);
    }
  </script>
</body>
</html>
