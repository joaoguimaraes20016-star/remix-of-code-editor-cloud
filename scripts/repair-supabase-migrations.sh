#!/bin/bash

# Script to repair Supabase migration history
# This script marks migrations as "reverted" that are in the remote database
# but not in the local migrations directory

set -e

echo "Starting Supabase migration repair..."

# List of migrations to mark as reverted (from the error message)
# These are migrations that exist in remote but not locally

REVERTED_MIGRATIONS=(
  # UUID-based migrations from October 2025
  "20251015234728_beb572c9-c1b0-439c-a172-c0a260129671.sql"
  "20251015234821_fdeb02fb-98b6-42c8-93f0-64d98974ae06.sql"
  "20251015235145_19ca6b16-bfbd-4f61-9ed6-991fe6264ad0.sql"
  "20251015235422_534169cc-d3cd-4262-878d-aab4949dfc4e.sql"
  "20251015235810_7a48c1c2-7450-444d-a708-b414dd6d01a1.sql"
  "20251016001521_c85ec6b6-87f3-47f3-8dd8-c85e55276d02.sql"
  "20251016002709_7cbe78f5-20ba-466c-a4ef-324008954c95.sql"
  "20251016004345_4ed50adb-1d9d-4dbd-8028-a6d629baafae.sql"
  "20251016015736_d8ee6ead-b25d-4168-bcd2-14685324c718.sql"
  "20251016015857_03794fe3-2afc-4496-ba38-fd93623e0422.sql"
  "20251016020332_0ac69cca-2098-45f9-a43d-1c6322f7b7ea.sql"
  "20251016021630_dfedd7fa-3bc4-4091-8573-4339e3db653c.sql"
  "20251016023244_a9d4e430-57b2-4580-8e6d-15c4a3ba2ca2.sql"
  "20251016025401_f20d4817-2270-4091-a5fc-b37fd0dc3cf9.sql"
  "20251016025800_ba6a2e71-6351-4c44-85ca-6f2f1f6b0225.sql"
  "20251016025857_1631075d-b8c5-4c40-bde7-a79ebe83cb2f.sql"
  "20251016031733_190381c2-89de-46ee-b198-800307a3b16e.sql"
  "20251016032539_c9485176-61a1-4f83-ad3b-045bea5f0688.sql"
  "20251016042642_2c8a269f-0a40-4c0c-bf8d-b0e9e2ed4097.sql"
  "20251016135223_ef397582-4299-45e2-ab0e-d2542132a5e0.sql"
  "20251016145042_6e3616cb-f49e-4922-a1b5-bb378a194646.sql"
  "20251016150452_8aecc311-2e77-4ae5-9add-b1780f183227.sql"
  "20251016162954_22737ac9-c4aa-460b-bbfa-3e075f630462.sql"
  "20251016164408_d2704562-8548-40bf-9155-ef6409621b1d.sql"
  "20251016164800_9e0c6616-d395-44fa-9906-95071604ebb7.sql"
  "20251016165823_de49168f-cb18-4977-8fc4-de5b84f8fbb2.sql"
  "20251016170119_007ed19e-092b-43af-ba21-021b7f50ae6e.sql"
  "20251016170600_475653cf-58de-46d9-b797-191ddc678dbd.sql"
  "20251016170733_b00ee8cb-d798-423a-9bda-f09d0ff44ba4.sql"
  "20251016172511_1e60eedc-6024-41f9-bfd2-4e9a956c633f.sql"
  "20251016233518_5dc86d6f-fae5-4771-bbea-8a9a416a86c1.sql"
  "20251017013713_784eaf79-06f5-40e0-9db6-7f5a2b0d8acd.sql"
  "20251017024416_f8e5eab7-96a0-4502-ac69-864b102b88ca.sql"
  "20251017025816_bc86a482-ca7a-4af3-bc3b-5c3e3d2b1a4c.sql"
  "20251017031717_8eb0a6f7-ab38-47c7-b7b0-029be5e4c55f.sql"
  "20251017173724_a3387a36-4bca-4056-8e92-095539e68c05.sql"
  "20251017183911_30b59d1f-7e6d-44dd-8ede-a53b3911da2d.sql"
  "20251018183638_5d6e0dc5-81ac-4e90-a623-9aa4882d6d49.sql"
  "20251018224743_1e8f6a2e-2cf1-4c9a-b3f4-70b43b0e7e15.sql"
  "20251018232157_082f670d-105a-4614-bfd3-fe725db15aca.sql"
  "20251018232633_ef1705ab-f392-43b9-8b6d-55249e0b3213.sql"
  "20251018232933_949389f0-8992-478a-b4ba-b55d15438445.sql"
  "20251018233113_56e5bbed-808f-4c6d-bf4c-91a59c0247b5.sql"
  "20251018233319_b21ae511-7e78-49b5-b661-9031e7e61e31.sql"
  "20251018233335_18ef8a6f-ad16-47a1-afe5-f6c0e0d54b58.sql"
  "20251019001439_669e1c5f-29db-4180-9ed2-39ba1392e321.sql"
  "20251019013045_39eec767-3456-4470-937e-807f4e140402.sql"
  "20251019140115_832e1d8d-5506-4233-a19e-81b92ec419bc.sql"
  "20251019203518_e234ff35-33c9-46a9-b337-408a9f76c47d.sql"
  "20251019223945_21c90ded-19f3-4f69-8399-8c634354e20b.sql"
  "20251020160737_2d98530e-c241-4f09-b678-0cbc2cd0b049.sql"
  "20251020163757_8849353e-6bc4-4388-bf2e-8c262e1373f0.sql"
  "20251020164847_f41a4974-ec7b-4a30-b0db-ff27c7c1f604.sql"
  "20251021164337_c6dee4b3-3e75-4568-97d4-e28dfa2e0b62.sql"
  "20251021171144_666b835a-bbed-4917-b2a3-ae0885f9c523.sql"
  # Timestamp-only migrations from December 2025
  "20251220044339"
  "20251220044340"
  "20251220044341"
  "20251220044342"
  "20251220044345"
  "20251220044346"
  "20251220044351"
  "20251220044352"
  "20251220044353"
  "20251220044354"
  "20251220044355"
  "20251220044357"
  "20251220044358"
  "20251220044400"
  "20251220044402"
  "20251220044403"
  "20251220044404"
  "20251220044405"
  "20251220044406"
  "20251220044408"
  "20251220044409"
  "20251220044411"
  "20251220044413"
  "20251220044416"
  "20251220044418"
  "20251220044419"
  "20251220044420"
  "20251220044421"
  "20251220044423"
  "20251220044424"
  "20251220044425"
  "20251220044427"
  "20251220044431"
  "20251220044432"
  "20251220044433"
  "20251220044434"
  "20251220044435"
  "20251220044436"
  "20251220044437"
  "20251220044438"
  "20251220044439"
  "20251220044442"
  "20251220044443"
  "20251220044445"
  "20251220044447"
  "20251220044450"
  "20251220044451"
  "20251220044452"
  "20251220044456"
  "20251220044457"
  "20251220044458"
  "20251220044459"
  "20251220044501"
  "20251220044502"
  "20251220044504"
  "20251220044506"
  "20251220044507"
  "20251220044508"
  "20251220044510"
  "20251220044512"
  "20251220044513"
  "20251220044514"
  "20251220044515"
  "20251220044516"
  "20251220044517"
  "20251220044519"
  "20251220044520"
  "20251220044521"
  "20251220044522"
  "20251220044523"
  "20251220044524"
  "20251220044525"
  "20251220044526"
  "20251220044528"
  "20251220044529"
  "20251220044530"
  "20251220044531"
  "20251220044532"
  "20251220044533"
  "20251220044534"
  "20251220044535"
  "20251220044536"
  "20251220044537"
  "20251220044538"
  "20251220044539"
  "20251220044540"
  "20251220044541"
  "20251220044543"
  "20251220044544"
  "20251220044546"
  "20251220044547"
  "20251220044548"
  "20251220044551"
  "20251220044552"
  "20251220044553"
  "20251220044554"
  "20251220044555"
  "20251220044556"
  "20251220044557"
  "20251220044559"
  "20251220044600"
  "20251220044601"
  "20251220044602"
  "20251220044603"
  "20251220044604"
  "20251220044605"
  "20251220044606"
  "20251220044607"
  "20251220044610"
  "20251220044611"
  "20251220044613"
  "20251220044615"
  "20251220044616"
  "20251220044617"
  "20251220044618"
  "20251220044619"
  "20251220044620"
  "20251220044621"
  "20251220044622"
  "20251220044623"
  "20251220044624"
  "20251220044625"
  "20251220044626"
  "20251220044627"
  "20251220044628"
  "20251220044629"
  "20251220044630"
  "20251220044631"
  "20251220044632"
  "20251220044633"
  "20251220044634"
  "20251220044635"
  "20251220044636"
  "20251220044637"
  "20251220044638"
  "20251220044639"
  "20251220044640"
  "20251220044641"
  "20251220044642"
  "20251220044643"
  "20251220044644"
  "20251220044645"
  "20251220044646"
  "20251220044647"
  "20251220044648"
  "20251220044649"
  "20251220044650"
  "20251220044651"
  "20251220044652"
  "20251220044653"
  "20251220044654"
  "20251220044655"
  "20251220044656"
  "20251220044657"
  "20251220044658"
  "20251220044659"
  "20251220044700"
  "20251220044701"
  "20251220044702"
  "20251220044703"
  "20251220044704"
  "20251220044705"
  "20251220044706"
  "20251220044707"
  "20251220044708"
  "20251220044709"
  "20251220044710"
  "20251220044711"
  "20251220044712"
  "20251220044713"
  "20251220044714"
  "20251220044715"
  "20251220044717"
  "20251220044719"
  "20251220044721"
  "20251220044722"
  "20251220044723"
  "20251220044724"
  "20251220044725"
  "20251220044726"
  "20251220044727"
  "20251220044838"
  "20251220044839"
  "20251220044840"
  "20251220044841"
  "20251220044842"
  "20251220044843"
  "20251220044845"
  "20251220044850"
  "20251220044851"
  "20251220044852"
  "20251220044853"
  "20251220044854"
  "20251220044855"
  "20251220044856"
  "20251220044858"
  "20251220044900"
  "20251220044901"
  "20251220044902"
  "20251220044903"
  "20251220044904"
  "20251220044906"
  "20251220044907"
  "20251220044908"
  "20251220044910"
  "20251220045042"
  "20251220045043"
  "20251220045044"
  "20251220045045"
  "20251220045046"
  "20251220045048"
  "20251220045050"
  "20251220045055"
  "20251220045056"
  "20251220045057"
  "20251220045058"
  "20251220045059"
  "20251220045100"
  "20251220045102"
  "20251220045104"
  "20251220045105"
  "20251220045106"
  "20251220045107"
  "20251220045108"
  "20251220045109"
  "20251220045111"
  "20251220045112"
  "20251220045113"
  "20251220045115"
  "20251220045117"
  "20251220045120"
  "20251220045122"
  "20251220045123"
  "20251220045124"
  "20251220045127"
  "20251220045128"
  "20251220045129"
  "20251220045131"
  "20251220045135"
  "20251220045136"
  "20251220045137"
  "20251220045138"
  "20251220045140"
  "20251220045141"
  "20251220045142"
  "20251220045143"
  "20251220045144"
  "20251220045146"
  "20251220045147"
  "20251220045149"
  "20251220045151"
  "20251220045154"
  "20251220045156"
  "20251220045201"
  "20251220045202"
  "20251220045203"
  "20251220045204"
  "20251220045206"
  "20251220045208"
  "20251220045209"
  "20251220045210"
  "20251220045212"
  "20251220045213"
  "20251220045215"
  "20251220045216"
  "20251220045217"
  "20251220045218"
  "20251220045220"
  "20251220045221"
  "20251220045222"
  "20251220045223"
  "20251220045224"
  "20251220045225"
  "20251220045226"
  "20251220045227"
  "20251220045228"
  "20251220045229"
  "20251220045231"
  "20251220045232"
  "20251220045233"
  "20251220045234"
  "20251220045235"
  "20251220045237"
  "20251220045238"
  "20251220045239"
  "20251220045240"
  "20251220045241"
  "20251220045242"
  "20251220045243"
  "20251220045244"
  "20251220045245"
  "20251220045247"
  "20251220045248"
  "20251220045249"
  "20251220045250"
  "20251220045251"
  "20251220045255"
  "20251220045256"
  "20251220045257"
  "20251220045258"
  "20251220045259"
  "20251220045300"
  "20251220045301"
  "20251220045303"
  "20251220045304"
  "20251220045305"
  "20251220045306"
  "20251220045307"
  "20251220045308"
  "20251220045309"
  "20251220045310"
  "20251220045311"
  "20251220045312"
  "20251220045314"
  "20251220045315"
  "20251220045317"
  "20251220045319"
  "20251220045320"
  "20251220045322"
  "20251220045323"
  "20251220045324"
  "20251220045325"
  "20251220045326"
  "20251220045327"
  "20251220045328"
  "20251220045329"
  "20251220045330"
  "20251220045331"
  "20251220045332"
  "20251220045333"
  "20251220045334"
  "20251220045336"
  "20251220045337"
  "20251220045338"
  "20251220045339"
  "20251220045340"
  "20251220045341"
  "20251220045344"
  "20251220045345"
  "20251220045346"
  "20251220045347"
  "20251220045348"
  "20251220045352"
  "20251220045353"
  "20251220045354"
  "20251220045357"
  "20251220045358"
  "20251220045401"
  "20251220045403"
  "20251220045404"
  "20251220045405"
  "20251220045406"
  "20251220045407"
  "20251220045408"
  "20251220045410"
  "20251220045411"
  "20251220045412"
  "20251220045414"
  "20251220045415"
  "20251220045416"
  "20251220045910"
  "20251220045911"
  "20251220045912"
  "20251220045913"
  "20251220045914"
  "20251220045916"
  "20251220045918"
  "20251220045923"
  "20251220045924"
  "20251220045925"
  "20251220045926"
  "20251220045927"
  "20251220045928"
  "20251220045929"
  "20251220045931"
  "20251220045933"
  "20251220045934"
  "20251220045935"
  "20251220045936"
  "20251220045937"
  "20251220045939"
  "20251220045940"
  "20251220045941"
  "20251220045943"
  "20251220045945"
  "20251220045948"
  "20251220045950"
  "20251220045951"
  "20251220045952"
  "20251220045955"
  "20251220045956"
  "20251220045957"
  "20251220045959"
  "20251220050003"
  "20251220050004"
  "20251220050005"
  "20251220050006"
  "20251220050007"
  "20251220050008"
  "20251220050009"
  "20251220050010"
  "20251220050013"
  "20251220050014"
  "20251220050016"
  "20251220050018"
  "20251220050021"
  "20251220050023"
  "20251220050028"
  "20251220050029"
  "20251220050030"
  "20251220050031"
  "20251220050033"
  "20251220050034"
  "20251220050036"
  "20251220050037"
  "20251220050038"
  "20251220050040"
  "20251220050041"
  "20251220050043"
  "20251220050044"
  "20251220050045"
  "20251220050046"
  "20251220050048"
  "20251220050049"
  "20251220050050"
  "20251220050051"
  "20251220050052"
  "20251220050053"
  "20251220050054"
  "20251220050055"
  "20251220050056"
  "20251220050058"
  "20251220050059"
  "20251220050100"
  "20251220050101"
  "20251220050102"
  "20251220050103"
  "20251220050105"
  "20251220050107"
  "20251220050108"
  "20251220050109"
  "20251220050110"
  "20251220050111"
  "20251220050113"
  "20251220050115"
  "20251220050117"
  "20251220050118"
  "20251220050122"
  "20251220050123"
  "20251220050124"
  "20251220050125"
  "20251220050126"
  "20251220050127"
  "20251220050128"
  "20251220050130"
  "20251220050132"
  "20251220050133"
  "20251220050134"
  "20251220050135"
  "20251220050136"
  "20251220050137"
  "20251220050138"
  "20251220050141"
  "20251220050142"
  "20251220050144"
  "20251220050146"
  "20251220050147"
  "20251220050148"
  "20251220050149"
  "20251220050150"
  "20251220050151"
  "20251220050152"
  "20251220050153"
  "20251220050154"
  "20251220050155"
  "20251220050156"
  "20251220050157"
  "20251220050158"
  "20251220050159"
  "20251220050200"
  "20251220050201"
  "20251220050202"
  "20251220050204"
  "20251220050205"
  "20251220050206"
  "20251220050207"
  "20251220050208"
  "20251220050209"
  "20251220050212"
  "20251220050215"
  "20251220050216"
  "20251220050217"
  "20251220050218"
  "20251220050222"
  "20251220050223"
  "20251220050224"
  "20251220050227"
  "20251220050228"
  "20251220050231"
  "20251220050233"
  "20251220050234"
  "20251220050235"
  "20251220050236"
  "20251220050237"
  "20251220050238"
  "20251220050240"
  "20251220050241"
  "20251220050242"
  "20251220050243"
  "20251220050245"
  "20251220050246"
  "20251220050247"
  "20251220050331"
  "20251220050332"
  "20251220050333"
  "20251220050334"
  "20251220050335"
  "20251220050337"
  "20251220050339"
  "20251220050344"
  "20251220050345"
  "20251220050346"
  "20251220050347"
  "20251220050348"
  "20251220050349"
  "20251220050350"
  "20251220050352"
  "20251220050355"
  "20251220050356"
  "20251220050357"
  "20251220050358"
  "20251220050359"
  "20251220050401"
  "20251220050402"
  "20251220050403"
  "20251220050405"
  "20251220050407"
  "20251220050410"
  "20251220050412"
  "20251220050413"
  "20251220050414"
  "20251220050417"
  "20251220050418"
  "20251220050420"
  "20251220050424"
  "20251220050425"
  "20251220050426"
  "20251220050427"
  "20251220050428"
  "20251220050429"
  "20251220050430"
  "20251220050431"
  "20251220050432"
  "20251220050435"
  "20251220050436"
  "20251220050438"
  "20251220050440"
  "20251220050442"
  "20251220050444"
  "20251220050449"
  "20251220050450"
  "20251220050451"
  "20251220050452"
  "20251220050454"
  "20251220050455"
  "20251220050457"
  "20251220050458"
  "20251220050459"
  "20251220050501"
  "20251220050502"
  "20251220050503"
  "20251220050504"
  "20251220050505"
  "20251220050506"
  "20251220050508"
  "20251220050509"
  "20251220050510"
  "20251220050511"
  "20251220050512"
  "20251220050513"
  "20251220050514"
  "20251220050515"
  "20251220050516"
  "20251220050517"
  "20251220050519"
  "20251220050520"
  "20251220050521"
  "20251220050522"
  "20251220050523"
  "20251220050524"
  "20251220050525"
  "20251220050526"
  "20251220050527"
  "20251220050528"
  "20251220050529"
  "20251220050531"
  "20251220050532"
  "20251220050534"
  "20251220050536"
  "20251220050537"
  "20251220050538"
  "20251220050542"
  "20251220050543"
  "20251220050544"
  "20251220050545"
  "20251220050546"
  "20251220050547"
  "20251220050548"
  "20251220050550"
  "20251220050551"
  "20251220050552"
  "20251220050553"
  "20251220050554"
  "20251220050555"
  "20251220050556"
  "20251220050557"
  "20251220050558"
  "20251220050601"
  "20251220050602"
  "20251220050604"
  "20251220050606"
  "20251220050607"
  "20251220050608"
  "20251220050609"
  "20251220050610"
  "20251220050611"
  "20251220050612"
  "20251220050613"
  "20251220050614"
  "20251220050615"
  "20251220050616"
  "20251220050617"
  "20251220050618"
  "20251220050619"
  "20251220050620"
  "20251220050621"
  "20251220050622"
  "20251220050623"
  "20251220050625"
  "20251220050626"
  "20251220050627"
  "20251220050628"
  "20251220050631"
  "20251220050633"
  "20251220050634"
  "20251220050635"
  "20251220050636"
  "20251220050640"
  "20251220050641"
  "20251220050642"
  "20251220050645"
  "20251220050648"
  "20251220050650"
  "20251220050651"
  "20251220050652"
  "20251220050653"
  "20251220050654"
  "20251220050655"
  "20251220050657"
  "20251220050658"
  "20251220050659"
  "20251220050700"
  "20251220050702"
  "20251220050703"
  "20251220050704"
  "20251220051041"
  "20251220051042"
  "20251220051043"
  "20251220051044"
  "20251220051045"
  "20251220051047"
  "20251220051049"
  "20251220051053"
  "20251220051054"
  "20251220051055"
  "20251220051056"
  "20251220051057"
  "20251220051059"
  "20251220051100"
  "20251220051102"
  "20251220051104"
  "20251220051105"
  "20251220051106"
  "20251220051107"
  "20251220051109"
  "20251220051110"
  "20251220051111"
  "20251220051113"
  "20251220051115"
  "20251220051118"
  "20251220051120"
  "20251220051121"
  "20251220051122"
  "20251220051125"
  "20251220051126"
  "20251220051127"
  "20251220051129"
  "20251220051133"
  "20251220051134"
  "20251220051135"
  "20251220051137"
  "20251220051138"
  "20251220051139"
  "20251220051140"
  "20251220051145"
  "20251220051146"
  "20251220051148"
  "20251220051150"
  "20251220051152"
  "20251220051154"
  "20251220051159"
  "20251220051200"
  "20251220051201"
  "20251220051202"
  "20251220051204"
  "20251220051206"
  "20251220051207"
  "20251220051208"
  "20251220051210"
  "20251220051211"
  "20251220051213"
  "20251220051214"
  "20251220051215"
  "20251220051217"
  "20251220051218"
  "20251220051219"
  "20251220051220"
  "20251220051221"
  # January 2026 migrations
  "20260108161431"
  "20260118224646"
  "20260120225119"
  "20260121004932"
  "20260121021720"
  "20260121022523"
  "20260121044610"
  "20260121190043"
  "20260121203435"
  "20260121212342"
  "20260121225226"
  "20260122004434"
  "20260122010051"
  "20260122010535"
  "20260122050321"
  "20260122061455"
  "20260123041209"
  "20260123044956"
  "20260123175142"
  "20260123194622"
  "20260123195002"
  "20260124064026"
  "20260126190751"
  "20260126194211"
  "20260127182006"
)

# Count total migrations
TOTAL=${#REVERTED_MIGRATIONS[@]}
echo "Found $TOTAL migrations to repair"

# Process each migration
COUNTER=0
FAILED=0

for migration in "${REVERTED_MIGRATIONS[@]}"; do
  COUNTER=$((COUNTER + 1))
  echo "[$COUNTER/$TOTAL] Repairing migration: $migration"
  
  if npx supabase@latest migration repair --status reverted "$migration" 2>&1; then
    echo "✓ Successfully repaired: $migration"
  else
    echo "✗ Failed to repair: $migration"
    FAILED=$((FAILED + 1))
  fi
done

echo ""
echo "=========================================="
echo "Migration repair completed!"
echo "Total migrations processed: $TOTAL"
echo "Successful: $((TOTAL - FAILED))"
echo "Failed: $FAILED"
echo "=========================================="

if [ $FAILED -eq 0 ]; then
  echo ""
  echo "All migrations repaired successfully!"
  echo "You can now run: npx supabase@latest db pull"
else
  echo ""
  echo "Some migrations failed to repair. Please check the errors above."
  exit 1
fi
